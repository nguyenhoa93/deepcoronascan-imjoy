<docs lang="markdown">
  [TODO: write documentation for this plugin.]
</docs>

<config lang="json">
  {
  "name": "DeepCoronaScan",
  "type": "window",
  "tags": [],
  "ui": "",
  "version": "0.1.0",
  "cover": "",
  "description": "[TODO: describe this plugin with one sentence.]",
  "icon": "extension",
  "inputs": null,
  "outputs": null,
  "api_version": "0.1.8",
  "env": "",
  "permissions": [],
  "requirements": [
  "https://cdn.auth0.com/js/lock/11.28.1/lock.min.js",
  "https://cdn.auth0.com/js/auth0-spa-js/1.13.6/auth0-spa-js.production.js",
  "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css",
  "https://nguyenhoa93.github.io/deepcoronascan-imjoy/css/main.css",
  "https://nguyenhoa93.github.io/deepcoronascan-imjoy/css/util.css",
  "https://cdn.jsdelivr.net/npm/vuesax/dist/vuesax.css",
  "https://unpkg.com/vue/dist/vue.js",
  "https://unpkg.com/vuesax",
  "https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js",
  "https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js",
  "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css",
  "https://unpkg.com/zarr@0.4.0/zarr.umd.js"
  ],
  "dependencies": [],
  "defaults": {"fullscreen": true}
  }
</config>

<script lang="javascript">
const LOGOUT_URL = "https://imjoy.io/lite?plugin=https://github.com/nguyenhoa93/deepcoronascan-imjoy/blob/master/deepcoronascan.imjoy.html"
class Client {
  constructor(baseURL){
    this.baseURL = baseURL
    this.accessToken = null
  }
  async makeRequest(url, method, json){
    if(!this.accessToken) {
      await this.login()
    }
    if(!url.startsWith('http') && !url.startsWith('/')) url = this.baseURL + '/' + url;
    const headers = {'Authorization': `Bearer ${this.accessToken}`}
    let body = undefined
    if(json){
        headers['Content-Type'] = 'application/json'
        body = JSON.stringify(json)
    }
    const response = await fetch(url, {
      method,
      headers,
      body
    })
    const data = await response.json()
    if(data.success){
      return data.result
    }
    else{
      throw new Error(data.detail || data.error)
    }
  }
  async login(){
    const auth0 = await createAuth0Client({
      domain: 'imjoy.eu.auth0.com',
      client_id: 'ofsvx6A7LdMhG0hklr5JCAEawLv4Pyse'
    })
    await auth0.loginWithPopup({audience: 'https://imjoy.eu.auth0.com/api/v2/'});
    //logged in. you can get the user profile like this:
    const user = await auth0.getUser({audience: 'https://imjoy.eu.auth0.com/api/v2/'});
    this.isAdmin = false;
    if(user){
      if(!user.email_verified){
        api.alert(`Please verify your email (${user.email}) by clicking the link sent from Auth0.`)
        return
      }
      this.userInfo = user;
      if(user['https://api.imjoy.io/roles'].includes('admin'))
        this.isAdmin = true
      console.log(user);
    }
    this.auth0 = auth0;
    this.accessToken = await auth0.getTokenSilently({audience: 'https://imjoy.eu.auth0.com/api/v2/'});
  }
  async logout(){
    if(!this.auth0) {
      api.showMessage("You haven't logged in.")
      return;
    }
    await this.auth0.logout({returnTo: LOGOUT_URL});
  }
  async get(url){
    return this.makeRequest(url, 'GET')
  }
  async put(url, json){
    return this.makeRequest(url, 'PUT', json)
  }
  async post(url, json){
    return this.makeRequest(url, 'POST', json)
  }
  async delete(url){
    return this.makeRequest(url, 'DELETE')
  }
}

class FileReferenceStore {
  constructor(ref, target) {
    this.ref = ref;
    this.target = target;
  }

  _url(urlPath) {
    if(!urlPath){
      return this.target
    }
    const [protocol, path] = urlPath.split('://');
    if (protocol === 'https' || protocol === 'http') {
      return urlPath;
    }
    if (protocol === 'gc') {
      return 'https://storage.googleapis.com/' + path;
    }
    throw Error("Protocol not supported, got: " + JSON.stringify(protocol));
  }

  async getItem(key) {
    const res = this.ref[key];
    if (!res) {
      // Key not in store
      throw new zarr.KeyError(key);
    }
   
    if (res?.length !== 3) {
      // JSON data entry in reference 
      const meta = typeof res === 'string' ? res : JSON.stringify(res)
      const enc = new TextEncoder().encode(meta);
      return enc.buffer;
    }

    const [urlPath, offset, size] = res;
    const url = this._url(urlPath);
    const headers = {
      Range: `bytes=${offset}-${offset + size - 1}`
    };
    const value = await fetch(url, { headers }).then(res => res.arrayBuffer());
    return value;
  }

  containsItem(key) {
    return key in this.ref;
  }

  static async fromUrl(url, targetUrl) {
    const ref = await fetch(url).then(res => res.json());
    return new FileReferenceStore(ref, targetUrl);
  }
}

const app = new Vue({
  el: '#app',
  data: {
    client: null,
    tasks: null,
    baseUrl: 'https://ai.pasteur.fr',
    isAuthenticated: false,
    samples: [],
    selectedSample: null,
    sample: null,
    camCheck: null
  },
  methods: {
    async login(){
      // this.$vs.loading()
      try{
        this.client = new Client(this.baseUrl)
        this.tasks = await this.client.get(`${this.baseUrl}/tasks`)
        console.log("Client: ", this.client)
        console.log("Tasks: ", this.tasks)
        if (this.client.accessToken) {
          $("#logout-but").show()
          $("#avatar-img").show()
          $("#avatar-img").text(this.client.userInfo.name.charAt(0))
          if ("deepcoronascan" in this.tasks) {
            $("#eval-cam").show()
          }
          const all_samples = await this.client.get(`${this.baseUrl}/task/deepcoronascan/all`)
          for (const [key, sample_name] of Object.entries(all_samples)) {
            var sample_info = {}
            console.log(sample_name)
            sample_info["name"] = sample_name
            var sample = await this.client.get(`${this.baseUrl}/task/deepcoronascan/sample/${sample_name}/update`);
            var label = await fetch(sample.placeholder_files["annotation.json"]).then(res => res.json());
            if (label["result"] == "no"){
              sample_info["label"] = "#E30715"
            } else if (label["result"] == "yes"){
              sample_info["label"] = "#4CAF4F"
            }
            this.samples.push(sample_info)
          }
          console.log("Samples: ", this.samples)
        }
      }
      catch(e){
        api.alert(`Failed to connect to the backend server, error: ${e}`)
      }
      finally{
        this.$vs.loading.close()
      }
    },

    logout(){
      this.client.logout()
      this.client = null
      $("#eval-cam").hide()
      $("#authen-layout").hide()
      $("#disclaimer-layout").show()
    },

    goToPublic(){
      $("#disclaimer-layout").hide()
      $("#public-layout").show()
    },

    goBackDisclaimer(){
      $("#public-layout").hide()
      $("#disclaimer-layout").show()
    },

    goToAuthen(){
      $("#disclaimer-layout").hide()
      $("#authen-layout").show()
    },

    async showCAM(selectedSample){
      this.selectedSample = selectedSample
      console.log(this.selectedSample)
      this.sample = await this.client.get(`${this.baseUrl}/task/deepcoronascan/sample/${this.selectedSample}/update`)
      console.log("Sample: ", this.sample)
      this.camCheck = await fetch(this.sample.placeholder_files["annotation.json"]).then(res => res.json());
      this.camCheck = this.camCheck["result"]
      console.log(this.camCheck)
      $("#gradcam-form").show()
      const refUrl = this.sample.input_files["image.ome.tif_offsets.json"]
      const targetUrl = this.sample.input_files["image.ome.tif"]
      const store = await FileReferenceStore.fromUrl(refUrl, targetUrl)
      const viewer = await api.showDialog({src: 'https://hms-dbmi.github.io/vizarr'})
      const img = { "source": store, "name": this.selectedSample}
      viewer.add_image(img)
    },

    async saveCamEval(){
      try{
        const sample = this.sample
        const url = sample.target_files["annotation.json"]
        const options = {
          onUploadProgress: (progressEvent) => {
            const progress = Math.round(1.0 * progressEvent.loaded / file.size * 100.0)
            api.showMessage("uploading annotation, size: "+Math.round(file.size/1000000)+"MB, " + progress + "% uploaded.");
          }
        };
        const file = new File([JSON.stringify({"result": this.camCheck})], "annotation.json", {type:"application/json"})
        await axios.put(url, file, options)
      } catch(e) {
        api.alert(`Failed to save annotation, error: ${e}`)
      }
      
      if (this.camCheck == "yes") {
        this.samples.find(x => x.name == this.selectedSample).label = "#4CAF4F"
      } else if (this.camCheck == "yes") {
        this.samples.find(x => x.name == this.selectedSample).label = "#E30715"
      }
      console.log(this.samples)
    }
  }
})

class ImJoyPlugin {
  async setup() {

  }

  async run(ctx) {

  }
}

api.export(new ImJoyPlugin())
</script>

<window lang="html">
<div id="app">
  <nav class="navbar navbar-inverse">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://research.pasteur.fr/en/team/imaging-and-modeling/" target="_blank">Imaging and Modeling</a>
      </div>
      <ul class="nav navbar-nav navbar-right">
        <li>
          <button class="login100-form-btn" v-if="!client || !client.accessToken" @click="login()">
              Login
          </button>
        </li>
        <li>
          <button id="logout-but" class="login100-form-btn" @click="logout()" style="display:none;">
              Logout
          </button>
        </li>
        <li>
          <div id="avatar-img" style="display:none;"></div>
        </li>
      </ul>
    </div>
  </nav>

  <div id="disclaimer-layout" class="container-login100" style="background-image: url('https://github.com/nguyenhoa93/deepcoronascan-imjoy/raw/master/images/login-background.jpg');">
    <div class="wrap-login100">
      <span class="login100-form-logo">
        <i class="fas fa-lungs-virus" aria-hidden="true"></i>
      </span>

      <span class="login100-form-title p-b-34 p-t-27">
          DeepCoronaScan
      </span>

       <div class="text-center p-t-10 p-b-30">
         <hr>
        <font size="+1" color="#B03A2E">
          <b><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
          DISCLAIMER: This tool is only used for research purpose, NOT ready for medical diagnosis.</b>
        </font>
        <br>
        <hr>
        <br>
        By clicking the following button(s), I confirm to have understood the disclaimer.
      </div>

      <div class="container-login100-form-btn">
        <button class="login100-form-btn" @click="goToPublic()">
            <i class="far fa-play-circle" aria-hidden="true"> Live Demo</i>
        </button>
        <button id="eval-cam" v-if="client" class="login100-form-btn" style="display:none" @click="goToAuthen()">
            GradCAM Evaluation
        </button>
      </div>     
    </div>
  </div>

  <div id="authen-layout" style="display:none">
    <h1><center>GradCAM Evaluation</center></h1>
    <div class="sidenav">
      <hr style="color:#f1f1f1;">
      <h3 style="text-align:center;">Choose a CT scan</h3>
      <hr style="color:#f1f1f1;">
      <ul id="scan-list">
        <li v-for="sample in samples" :key="sample.name" :style="{background: sample.label}" @click="showCAM(sample.name)">
          {{ sample.name }}
        </li>
      </ul>

      <hr style="border: 3px double #487;">
      <form style="display:none;" id="gradcam-form">
        Is GradCAM of <span id="sample-name">{{ selectedSample }}</span> reasonable?<br>
        <input type="radio" name="label" value="yes" :checked="camCheck == 'yes'" v-model="camCheck"> Yes<br>
        <input type="radio" name="label" value="no" :checked="camCheck == 'no'" v-model="camCheck"> No<br>
        <button id="saveCAM" v-on:click="saveCamEval" class="login100-form-btn">
            <i class="fas fa-save" aria-hidden="true"> Save</i>
        </button>
      </form>
    </div> 
    <div class="main" id="scan">
      <iframe id="placeholder"
        title="placeholder"
        width="100%"
        height="600px"
        src="https://ourworldindata.org/grapher/total-cases-covid-19?tab=map">
      </iframe>
    </div>
  </div>

  <div id="public-layout" style="display:none">
    <hr>
    <h1>Update soon</h1>
    <button @click="goBackDisclaimer()">
      <i class="fas fa-backward" aria-hidden="true" style='font-size:30px'></i>
    </button>
  </div>

  <div class="wrapper-footer">
    <div class="container">
      <footer class="footer">
        <a href="https://sites.google.com/site/imagingandmodeling/" target="_blank">
          <i class="svg-icon googleplus"></i>
        </a>
        <a href="https://twitter.com/ImodLab" target="_blank">
          <i class="svg-icon twitter"></i>
        </a>
        <a href="https://github.com/imodpasteur" target="_blank">
          <i class="svg-icon github"></i>
        </a>
      </footer>
    </div>
  </div>
</div>
</window>

<style lang="css">
#avatar-img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #2193b0;
  font-size: 30px;
  color: #fff;
  text-align: center;
  line-height: 50px;
  margin: 0px 0;
}
/* Create two columns/boxes that floats next to each other */
.sidenav {
  float: left;
  width: 30%;
  background: #222222;
  padding: 20px;
}

.sidenav button {
  background-color: #2193b0;
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 4px 2px;
  cursor: pointer;
}

.sidenav ul li {
  padding: 6px 8px 6px 16px;
  text-decoration: none;
  font-size: 20px;
  color: #818181;
  display: block;
}

.sidenav ul li:hover {
  color: #f1f1f1;
}

.sidenav form {
  font-size: 20px;
  color: #f1f1f1;
}

.sidenav h3 {
  color: #f1f1f1;
}

.sidenav ul{height:300px; width:90%;}
.sidenav ul{overflow:hidden; overflow-y:scroll;}

.main {
  float: left;
  padding: 20px;
  width: 70%;
  background-color: #f1f1f1;
}

/* Clear floats after the columns */
section::after {
  content: "";
  display: table;
  clear: both;
}

/* Responsive layout - makes the two columns/boxes stack on top of each other instead of next to each other, on small screens */
@media (max-width: 600px) {
  sidenav, main {
    width: 100%;
    height: auto;
  }
}
</style>