<docs lang="markdown">
  [TODO: write documentation for this plugin.]
</docs>

<config lang="json">
  {
  "name": "DeepCoronaScan",
  "type": "window",
  "tags": [],
  "ui": "",
  "version": "0.1.0",
  "cover": "",
  "description": "[TODO: describe this plugin with one sentence.]",
  "icon": "extension",
  "inputs": null,
  "outputs": null,
  "api_version": "0.1.8",
  "env": "",
  "permissions": [],
  "requirements": [
  "https://cdn.auth0.com/js/lock/11.28.1/lock.min.js",
  "https://cdn.auth0.com/js/auth0-spa-js/1.13.6/auth0-spa-js.production.js",
  "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css",
  "https://nguyenhoa93.github.io/deepcoronascan-imjoy/css/main.css",
  "https://nguyenhoa93.github.io/deepcoronascan-imjoy/css/util.css",
  "https://cdn.jsdelivr.net/npm/vuesax/dist/vuesax.css",
  "https://unpkg.com/vue/dist/vue.js",
  "https://unpkg.com/vuesax",
  "https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js",
  "https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js",
  "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css",
  "https://kitware.github.io/itk-vtk-viewer/app/itkVtkViewerCDN.js"
  ],
  "dependencies": [],
  "defaults": {"w": 40, "h": 10}
  }
</config>

<script lang="javascript">
const LOGOUT_URL = "https://imjoy.io/lite?plugin=https://github.com/nguyenhoa93/deepcoronascan-imjoy/blob/master/deepcoronascan.imjoy.html"
class Client {
  constructor(baseURL){
    this.baseURL = baseURL
    this.accessToken = null
  }
  async makeRequest(url, method, json){
    if(!this.accessToken) {
      await this.login()
    }
    if(!url.startsWith('http') && !url.startsWith('/')) url = this.baseURL + '/' + url;
    const headers = {'Authorization': `Bearer ${this.accessToken}`}
    let body = undefined
    if(json){
        headers['Content-Type'] = 'application/json'
        body = JSON.stringify(json)
    }
    const response = await fetch(url, {
      method,
      headers,
      body
    })
    const data = await response.json()
    if(data.success){
      return data.result
    }
    else{
      throw new Error(data.detail || data.error)
    }
  }
  async login(){
    const auth0 = await createAuth0Client({
      domain: 'imjoy.eu.auth0.com',
      client_id: 'ofsvx6A7LdMhG0hklr5JCAEawLv4Pyse'
    })
    await auth0.loginWithPopup({audience: 'https://imjoy.eu.auth0.com/api/v2/'});
    //logged in. you can get the user profile like this:
    const user = await auth0.getUser({audience: 'https://imjoy.eu.auth0.com/api/v2/'});
    // const user = await auth0.getUser();
    this.isAdmin = false;
    if(user){
      if(!user.email_verified){
        api.alert(`Please verify your email (${user.email}) by clicking the link sent from Auth0.`)
        return
      }
      this.userInfo = user;
      if(user['https://api.imjoy.io/roles'].includes('admin'))
        this.isAdmin = true
      console.log(user);
    }
    this.auth0 = auth0;
    this.accessToken = await auth0.getTokenSilently({audience: 'https://imjoy.eu.auth0.com/api/v2/'});
  }
  async logout(){
    if(!this.auth0) {
      api.showMessage("You haven't logged in.")
      return;
    }
    console.log("Logout url: ", window.location.origin)
    await this.auth0.logout({returnTo: LOGOUT_URL});
  }
  async get(url){
    return this.makeRequest(url, 'GET')
  }
  async put(url, json){
    return this.makeRequest(url, 'PUT', json)
  }
  async post(url, json){
    return this.makeRequest(url, 'POST', json)
  }
  async delete(url){
    return this.makeRequest(url, 'DELETE')
  }
}

const app = new Vue({
  el: '#app',
  data: {
    client: null,
    tasks: null,
    baseUrl: 'https://ai.pasteur.fr'
  },
  methods: {
    async login(){
      this.$vs.loading()
      try{
        this.client = new Client(this.baseUrl)
        this.tasks = await this.client.get(`${this.baseUrl}/tasks`)
        console.log("Client: ", this.client)
        console.log("Tasks: ", this.tasks)
        if (this.client.user != "undefined") {
          // $("#logout-but").show()
          // $("#avatar-img").show()
          $("#avatar-img").text(this.client.userInfo.name.charAt(0))
          $("#eval-cam").show()
        }
      }
      catch(e){
        api.alert(`Failed to connect to the backend server, error: ${e}`)
      }
      finally{
        this.$vs.loading.close()
      }
    },

    logout(){
      this.client.logout()
      this.client = null
      $("#eval-cam").hide()
      $("#authen-layout").hide()
      $("#disclaimer-layout").show()
    },

    goToPublic(){
      $("#disclaimer-layout").hide()
      $("#public-layout").show()
    },

    goBackDisclaimer(){
      $("#public-layout").hide()
      $("#disclaimer-layout").show()
    },

    goToAuthen(){
      $("#disclaimer-layout").hide()
      $("#authen-layout").show()
      // $("#vis").show()
    },

    view3D(){
      window.open("https://kitware.github.io/itk-vtk-viewer/app/?fileToLoad=https://data.kitware.com/api/v1/file/564a65d58d777f7522dbfb61/download/data.nrrd", "_blank")
    }
  }
})

class ImJoyPlugin {
  async setup() {

  }

  async run(ctx) {

  }
}

api.export(new ImJoyPlugin())
</script>

<window lang="html">
<div id="app">
  <nav class="navbar navbar-inverse">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://research.pasteur.fr/en/team/imaging-and-modeling/" target="_blank">Imaging and Modeling</a>
      </div>
      <ul class="nav navbar-nav navbar-right">
        <li>
          <button class="login100-form-btn" v-if="!client || !client.accessToken" @click="login()">
              Login
          </button>
        </li>
        <li>
          <button id="logout-but" class="login100-form-btn" v-if="client" @click="logout()">
              Logout
          </button>
        </li>
        <li>
          <div id="avatar-img" v-if="client"></div>
        </li>
      </ul>
    </div>
  </nav>

  <div id="disclaimer-layout" class="container-login100" style="background-image: url('https://github.com/nguyenhoa93/deepcoronascan-imjoy/raw/master/images/login-background.jpg');">
    <div class="wrap-login100">
      <span class="login100-form-logo">
        <i class="fas fa-lungs-virus" aria-hidden="true"></i>
      </span>

      <span class="login100-form-title p-b-34 p-t-27">
          DeepCoronaScan
      </span>

       <div class="text-center p-t-10 p-b-30">
         <hr>
        <font size="+1" color="#B03A2E">
          <b><i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
          DISCLAIMER: This tool is only used for research purpose, NOT ready for medical diagnosis.</b>
        </font>
        <br>
        <hr>
        <br>
        By clicking the following button(s), I confirm to have understood the disclaimer.
      </div>

      <div class="container-login100-form-btn">
        <button class="login100-form-btn" @click="goToPublic()">
            <i class="far fa-play-circle" aria-hidden="true"> Live Demo</i>
        </button>
        <button id="eval-cam" v-if="client" class="login100-form-btn" style="display:none" @click="goToAuthen()">
            GradCAM Evaluation
        </button>
      </div>     
    </div>
  </div>

  <div id="authen-layout" v-if="client" style="display:none">
    <h1><center>GradCAM Evaluation</center></h1>
    <div class="login100-form-btn">
      <button id="view-3d" class="login100-form-btn" @click="view3D()">
         <i class="fas fa-cube" aria-hidden="true"> View 3D</i>
      </button>
    </div>
  </div>

  <!-- <div
    id="vis"
    style="float: center; display: inline-block; border: 2px solid gray; margin: 20px; margin-right: 20px;display:none;"
    class="itk-vtk-viewer"
    data-url="https://data.kitware.com/api/v1/file/564a65d58d777f7522dbfb61/download/data.nrrd"
    data-viewport="450x300"
  ></div> -->

  <div id="public-layout" style="display:none">
    <hr>
    <h1>Update soon</h1>
    <button @click="goBackDisclaimer()">
      <i class="fas fa-backward" aria-hidden="true" style='font-size:30px'></i>
    </button>
  </div>

  <div class="wrapper-footer">
    <div class="container">
      <footer class="footer">
        <a href="https://sites.google.com/site/imagingandmodeling/" target="_blank">
          <i class="svg-icon googleplus"></i>
        </a>
        <a href="https://twitter.com/ImodLab" target="_blank">
          <i class="svg-icon twitter"></i>
        </a>
        <a href="https://github.com/imodpasteur" target="_blank">
          <i class="svg-icon github"></i>
        </a>
      </footer>
    </div>
  </div>
</div>
</window>

<style lang="css">
#avatar-img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #2193b0;
  font-size: 30px;
  color: #fff;
  text-align: center;
  line-height: 50px;
  margin: 0px 0;
}
</style>